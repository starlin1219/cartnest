{% extends "cart_base.html" %}
{% load static %}

{% block title %}CUI LIANG SHI | è³¼ç‰©è»Š{% endblock title %}

{% block style %}
<style>
    @media (max-width: 992px) {
        .subtotal {
            display: none;
        }
    }
    
    .table td {
        padding: 2rem 1rem 2rem 1rem;
    }
    .table th {
        padding: 0 0 1rem 1rem
    }
    /* æ§åˆ¶æ•´é«”å°é½Šæ•ˆæœ */
    .table td, .table th {
        vertical-align: middle;
    }

    input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        vertical-align: middle;
    }

    
    .quantity-control {
        display: flex;
        align-items: center;
        border: 1px solid #ccc;
        border-radius: 8px;
        overflow: hidden;
        width: 90px;
        background-color: #f9f9f9;
    }

    .quantity-btn, 
    .quantity-input {
        width: 30px; /* è®“æ‰€æœ‰å…ƒç´ çš„å¯¬åº¦ç›¸ç­‰ */
        height: 30px;
        text-align: center;
        font-size: 1rem;
        font-weight: bold;
        border: none;
        background-color: #ffffff;
        color: #333;
        transition: background-color 0.2s;
    }

    .quantity-btn:hover {
        background-color: #e0e0e0;
        cursor: pointer;
    }

    /* ç§»é™¤ input number é è¨­ç®­é ­ */
    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .quantity-input[type="number"] {
        -moz-appearance: textfield;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
    }

    /* æœªé”å…é‹æ™‚ï¼ˆç´…è‰²ï¼‰ */
    .remaining-for-free-shipping.not-free {
        color: #e74c3c; /* ç´…è‰² */
    }

    /* å·²é”å…é‹æ™‚ï¼ˆè—è‰²ï¼‰ */
    .remaining-for-free-shipping.free {
        color: #3498db; /* è—è‰² */
    }

    .coupon-input {
        border: 1px solid #ccc;
        border-right: none;
        padding: 10px;
        color: #999;
        background-color: #f9f9f9;
        outline: none;
        box-shadow: none;
        border-radius: 6px 0 0 6px;
        width: 50%; /* èª¿æ•´å¯¬åº¦ */
        max-width: 250px;
    }

    .coupon-btn {
        background-color: #d3d3d3; /* æ›´æ·ºçš„ç°è‰² */
        border: 1px solid #d3d3d3;
        color: #333;
        padding: 10px 20px;
        border-radius: 0 6px 6px 0;
        transition: background-color 0.2s ease;
    }

    .coupon-btn:hover {
        background-color: #b0b0b0;
        border-color: #b0b0b0;
    }


    /* èª¿æ•´æŠ˜æ‰£é …ç›®æ¨£å¼ */
    .accordion-button {
        background-color: #f9f9f9;
        color: #333;
        font-weight: bold;
    }

    .accordion-button:focus {
        box-shadow: none;
    }

    .accordion-button:not(.collapsed) {
        background-color: #e0e0e0;
    }

    .accordion-body {
        background-color: #f9f9f9;
    }

</style>
{% endblock style %}


{% block content %}
<div class="step-container justify-content-center mt-5">
    <div class="step active">
        <span class="circle">1</span>
        <span class="label">è³¼ç‰©è»Šæ˜ç´°</span>
    </div>
    <div class="divider"></div>
    <div class="step">
        <span class="circle">2</span>
        <span class="label">è¨‚å–®ç¢ºèªã€å¡«å¯«è¨‚è³¼è³‡æ–™</span>
    </div>
    <div class="divider"></div>
    <div class="step">
        <span class="circle">3</span>
        <span class="label">è³¼è²·å®Œæˆ</span>
    </div>
</div>

<div class="row justify-content-center" style="min-height: 32rem;">
    <div class="box col-xxl-8 col-xl-9 col-lg-10 px-4 py-3">    
        <div class="row">
            
            <div style="display: flex; align-items: center;" class="ms-2 my-3">
                <div class="bar"></div>
                <h4 class="pt-1">è³¼ç‰©è»Šæ˜ç´°</h4>
            </div>
            <hr style="border-top: 1px solid #999; width: 98%;" class="mx-auto">

            <div class="col">
                {% if cart.items %}
                <table class="table">
                
                    <tr>
                        <th>
                            <input type="checkbox" onclick="toggleSelectAll(this)">
                        </th>
                        <th colspan="2">
                            å•†å“
                        </th>
                        <th>
                            å•†å“æ•¸é‡
                        </th>
                        <th class="subtotal">
                            å°è¨ˆ
                        </th>
                    </tr>

                    {% for key, item in cart.items %}
                    <tr data-key="{{ key }}">
                        <td>
                            <!-- å¦‚æœ cart.items å­˜åœ¨ï¼Œé è¨­å‹¾é¸ -->
                            <input type="checkbox" class="item-checkbox" onchange="updateTotal()" checked>
                        </td>
                        <td>
                            <a href="{% url 'product_detail' %}?variant={{ key }}">
                                <img src="{% static 'product_images/' %}{{ item.image }}" alt="{{ item.name }}" style="width: 10rem;">
                            </a>
                        </td>
                        <td>
                            <a href="{% url 'product_detail' %}?variant={{ key }}">
                                <p>
                                {{ item.name }} {{ item.size }} 
                                {% if item.package != 'å–®å…¥' %}{{ item.package }}{% endif %}
                                </p>
                                <p>${{ item.price }}</p>
                            </a>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <div class="quantity-control">
                                    <button class="quantity-btn" onclick="decreaseQuantity(this, '{{ key }}')">âˆ’</button>
                                    <input type="number" class="quantity-input" value="{{ item.quantity }}" min="1" data-key="{{ key }}" data-prev="{{ item.quantity }}">
                                    <button class="quantity-btn" onclick="increaseQuantity(this, '{{ key }}')">+</button>
                                </div>
                                <div class="d-flex mt-3 ms-3">
                                    <i class="bi {% if key in favorite_variants %}bi-heart-fill{% else %}bi-heart{% endif %}
                                        text-danger favorite-icon me-3"
                                        style="font-size: 1.3rem; cursor: pointer;"
                                        data-variant-id="{{ key }}">
                                    </i>

                                    <!-- é»æ“Šæ™‚è§¸ç™¼ JavaScriptï¼Œä½†ä¸æœƒè·³è½‰é é¢ -->
                                    <a href="javascript:void(0)" onclick="removeCartItem('{{ key }}')"><i class="bi bi-trash3 fs-5"></i></a>
                                </div>
                            </div>
                        </td>
                        <td class="subtotal">
                            ${{ item.subtotal }}
                        </td>
                    </tr>
                    {% endfor %}

                    <tr id="gift-row" class="{% if gifts|length > 0 %}d-table-row{% else %}d-none{% endif %}">
                        <td colspan="5">
                            <p>æ´»å‹•è´ˆå“:</p>
                            <ul id="gift-list">
                                {% for gift in gifts %}
                                    <li class="mt-2">
                                        {{ gift.promo_name }}
                                        {{ gift.conditions }}
                                        - è´ˆå“: 
                                        {{ gift.product_name }} 
                                        {% if gift.size %}- {{ gift.size }}{% endif %}
                                        {% if gift.package %}
                                            {% if gift.package != 'å–®å…¥' %}
                                            - {{ gift.package }}
                                            {% endif %}
                                        {% endif %}
                                        x {{ gift.quantity }}
                                        {% if gift.source == 'auto' %}
                                            <span class="badge bg-success ms-2">æ´»å‹•</span>
                                        {% elif gift.source == 'coupon' %}
                                            <span class="badge bg-primary ms-2">å„ªæƒ ç¢¼</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>


                    <tr>
                        <td colspan="5">
                            <p>å•†å“ç¸½é‡‘é¡: <span class="total-amount">${{ total }}</span></p>
                            <p>é‹è²»: <span class="shipping-cost">$100</span></p>
                            <p class="remaining-for-free-shipping"></p>
                    
                            <!-- å„ªæƒ ç¢¼è¼¸å…¥æ¡† -->
                            <p class="input-group">
                                <input type="search" class="form-control coupon-input" id="coupon-code" placeholder="è¼¸å…¥å„ªæƒ ç¢¼" value="{{ request.session.promo_code }}">
                                <button class="btn coupon-btn" type="button" onclick="applyCoupon()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="é»æ“Šå¥—ç”¨å„ªæƒ åˆ¸">
                                    <i class="bi bi-check"></i>
                                </button>
                            </p> 
                            
                            <p>æŠ˜æ‰£: <span id="discount-amount">${{ discount }}</span></p>
                            
                            <!-- æŠ˜æ‰£ Accordion -->
                            <p>
                                <div class="accordion" id="discountAccordion"> <!-- style="display: none;" -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="headingDiscount">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDiscount" aria-expanded="false" aria-controls="collapseDiscount">
                                                æŸ¥çœ‹å„ªæƒ é …ç›®
                                            </button>
                                        </h2>
                                        <div id="collapseDiscount" class="accordion-collapse collapse" aria-labelledby="headingDiscount" data-bs-parent="#discountAccordion">
                                            <div class="accordion-body">
                                                {% if active_promotions %}
                                                    <ul>
                                                        {% for promo in active_promotions %}
                                                            <li>{{ promo.promo_name }} {{promo.conditions}}- æŠ˜æ‰£ ${{ promo.discount }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <p>å°šæœªå¥—ç”¨å„ªæƒ </p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </p>
                        </td>
                    </tr>

                    <tr>
                        <td colspan="5">
                            <h5>çµå¸³é‡‘é¡: <span class="final-amount">${{ final_total }}</span></h5>
                            <button id="checkout-btn" class="btn btn-primary w-100 mt-3" onclick="goToCheckOrder()">çµå¸³</button>

                        </td>
                    </tr>
                
                    
                </table>

                {% else %}
                    <!-- é¡¯ç¤ºç©ºè³¼ç‰©è»Šç•«é¢ -->
                    <div class="text-center py-5">
                        <i class="bi bi-cart-x fs-1 text-muted"></i>
                        <h4 class="text-muted mt-3">æ‚¨çš„è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼</h4>
                        <a href="{% url 'home' %}" class="btn btn-primary mt-4">ç¹¼çºŒè³¼ç‰©</a>
                    </div>
                {% endif %}
                
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block UI %}
<!-- éŒ¯èª¤æç¤º Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="errorModalLabel">æç¤º</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="modalCloseBtn"></button>
            </div>
            <div class="modal-body" id="errorModalMessage">
                ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="modalRedirectBtn" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<!-- åˆªé™¤ç¢ºèª Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center" id="confirmDeleteLabel">
                    <i class="bi bi-trash3-fill text-danger me-2 fs-4"></i>
                    ç¢ºèªåˆªé™¤
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
            </div>
            <div class="modal-body">
                ç¢ºå®šè¦ç§»é™¤é€™å€‹å•†å“å—ï¼Ÿ
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>
</div>
{% endblock UI %}

{% block script %}
<script>
    
    document.addEventListener('DOMContentLoaded', () => {

        // å–å¾—æ‰€æœ‰ checkbox ä¸¦é è¨­å‹¾é¸
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.checked = true;
    
            checkbox.addEventListener('change', () => {
                updateTotal();
                updateCartSummary();
                updateCheckoutButton();
            });
        });

        // è¨­å®šã€Œå…¨é¸æ¡†ã€åŒæ­¥ç‚ºå‹¾é¸ç‹€æ…‹
        let selectAllCheckbox = document.querySelector('input[type="checkbox"][onclick="toggleSelectAll(this)"]');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = true;
        }

        // é é¢è¼‰å…¥æ™‚æ›´æ–°ç¸½é‡‘é¡èˆ‡æŠ˜æ‰£
        updateTotal();
        updateCheckoutButton();

        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // è‹¥æœ‰å„ªæƒ ç¢¼ â†’ å¥—ç”¨å·²å¥—ç”¨æ¨£å¼
        const promoCode = document.getElementById('coupon-code')?.value.trim();
        if (promoCode) {
            switchToAppliedStyle();
        }
        
    });

    // å–å¾— CSRF token
    const csrftoken = '{{ csrf_token }}';

    // å…¨å±€è¨­å®š AJAX çš„ CSRF token
    $.ajaxSetup({
        headers: { "X-CSRFToken": csrftoken }
    });

    function showErrorModal(message, title = 'æç¤º') {
        const modal = new bootstrap.Modal(document.getElementById('errorModal'));
        document.getElementById('errorModalLabel').innerText = title;
        document.getElementById('errorModalMessage').innerText = message;
        modal.show();
    }        

    $('.favorite-icon').click(function () {
        const icon = $(this);
        const variantId = icon.data('variant-id');
    
        $.ajax({
            url: "{% url 'toggle_favorite' %}",
            type: 'POST',
            data: { 'variant_id': variantId },
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function (response) {
                if (response.status === 'added') {
                    icon.removeClass('bi-heart').addClass('bi-heart-fill');
                } else if (response.status === 'removed') {
                    icon.removeClass('bi-heart-fill').addClass('bi-heart');
                }
            },
            error: function () {
                showErrorModal('æ“ä½œå¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥æˆ–ç¨å¾Œå†è©¦');
            }
        });
    });


    function updateCheckoutButton() {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        const checkoutBtn = document.getElementById('checkout-btn');
    
        if (!checkoutBtn) return;
    
        const hasChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
        const hasItems = checkboxes.length > 0;
    
        if (!hasItems || !hasChecked) {
            checkoutBtn.setAttribute('disabled', 'disabled');
        } else {
            checkoutBtn.removeAttribute('disabled');
        }
    }
    

    // é¸å–æˆ–å–æ¶ˆé¸å–æ‰€æœ‰å•†å“
    function toggleSelectAll(source) {
        let checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
        });
        updateTotal(); // æ›´æ–°ç¸½é‡‘é¡
        updateCartSummary();      
        updateCheckoutButton();
    }

    // å¢åŠ æ•¸é‡
    function increaseQuantity(button) {
        let input = button.closest('.quantity-control').querySelector('.quantity-input');
        let key = input.getAttribute('data-key');
        let value = parseInt(input.value);

        input.setAttribute('data-prev', value); // è¨˜éŒ„ç›®å‰æ•¸å€¼
        input.value = value + 1;

        updateCartItem(key, input.value);
    }

    // æ¸›å°‘æ•¸é‡ï¼ˆæœ€å°å€¼ç‚º 1ï¼‰
    function decreaseQuantity(button) {
        let input = button.closest('.quantity-control').querySelector('.quantity-input');
        let key = input.getAttribute('data-key');
        let value = parseInt(input.value);

        if (value > 1) {
            input.setAttribute('data-prev', value); // è¨˜éŒ„ç›®å‰æ•¸å€¼
            input.value = value - 1;
            updateCartItem(key, input.value);
        } else if (value === 1) {
            // é¡¯ç¤ºç¢ºèªæ¡†
            if (removeCartItem(key)) {
                
            } else {
                input.value = 1; // è‹¥ä½¿ç”¨è€…å–æ¶ˆï¼Œç¶­æŒ value åœ¨ 1
            }
        }
    }

    $(document).on('focusin', '.quantity-input', function () {
        $(this).attr('data-prev', this.value);  // ç•¶èšç„¦æ™‚å„²å­˜ç›®å‰å€¼
    });

    // ç›£è½è¼¸å…¥æ¡†çš„å€¼æ”¹è®Šäº‹ä»¶
    $(document).on('change', '.quantity-input', function() {
        let key = $(this).data('key');
        let quantity = parseInt($(this).val());

        if (quantity < 1) {
            quantity = 1;
            $(this).val(quantity);
        }

        updateCartItem(key, quantity);
    });

    // è³¼ç‰©è»Šå•†å“æ•¸é‡è®Šå‹•æ™‚
    function updateCartItem(key, quantity) {
        if (quantity < 1) {
            quantity = 1; // æœ€å°å€¼é™åˆ¶ç‚º 1
        }

        const input = $(`.quantity-input[data-key="${key}"]`);
        const prevValue = input.attr('data-prev') || input.val();  // å–å¾—ä¸Šä¸€æ¬¡ç´€éŒ„çš„æ•¸é‡

        $.ajax({
            url: `/update_cart_item/${key}/${quantity}/`,
            type: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            success: function(response) {
                if (response.success) {
                    // æ›´æ–°å°è¨ˆ
                    $(`tr[data-key="${key}"]`).find('.subtotal').text(`$${response.subtotal}`);
                    updateTotal(); // æ›´æ–°ç¸½é‡‘é¡
                    updateCartSummary();

                    // æ›´æ–°è³¼ç‰©è»Šæ•¸é‡å¾½ç« 
                    if (response.cart_count !== undefined) {
                        if (response.cart_count > 0) {
                            $('#cart-count').text(response.cart_count).show();
                        } else {
                            $('#cart-count').text('0').hide();
                        }
                    }

                    // è¨˜éŒ„é€™æ¬¡æˆåŠŸçš„å€¼
                    input.attr('data-prev', quantity);

                } else {
                    // è‹¥ç„¡ successï¼Œä½† status 200ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    showErrorModal(response.message || "æ›´æ–°å¤±æ•—");
                    input.val(prevValue).focus();  // é‚„åŸä¸¦èšç„¦
                }
            },
            error: function(xhr) {
                if (xhr.status === 400 && xhr.responseJSON?.stock_limit !== undefined) {
                    showErrorModal(`åº«å­˜ä¸è¶³ï¼Œæœ€å¤šåªèƒ½è³¼è²· ${xhr.responseJSON.stock_limit} ä»¶` || xhr.responseJSON.message);
                    // é‡è¨­æ•¸é‡ç‚ºåº«å­˜ä¸Šé™
                    input.val(xhr.responseJSON.stock_limit).focus();  // è‡ªå‹•ä¿®æ­£ç‚ºä¸Šé™
                    input.attr('data-prev', xhr.responseJSON.stock_limit);
                } else {
                    showErrorModal('æ›´æ–°æ•¸é‡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    input.val(prevValue).focus();  // é‚„åŸä¸¦èšç„¦
                }
            }
        });
    }

    let deleteTargetKey = null;

    function removeCartItem(key) {
        deleteTargetKey = key;  // æš«å­˜ key
        const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        modal.show();
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        if (!deleteTargetKey) return;
    
        $.ajax({
            url: `/remove_cart_item/${deleteTargetKey}/`,
            type: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            success: function(response) {
                if (response.success) {
                    $(`tr[data-key="${deleteTargetKey}"]`).remove();
    
                    if (response.cart_count > 0) {
                        $('#cart-count').text(response.cart_count).show();
                    } else {
                        $('#cart-count').hide();
                    }
    
                    if (document.querySelectorAll('tr[data-key]').length === 0) {
                        $('.table').remove();
                        $('.col').append(`
                            <div class="text-center py-5">
                                <i class="bi bi-cart-x fs-1 text-muted"></i>
                                <h4 class="text-muted mt-3">æ‚¨çš„è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼</h4>
                                <a href="/" class="btn btn-primary mt-4">ç¹¼çºŒè³¼ç‰©</a>
                            </div>
                        `);
                    } else {
                        updateTotal();
                        updateCartSummary();
                    }
    
                    bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                }
            }
        });
    });        


    // ç¨ç«‹è™•ç†é‹è²»é‚è¼¯
    function calculateShipping(total) {
        // å¦‚æœç¸½é‡‘é¡ â‰¥ 2500ï¼Œå…é‹è²»ï¼Œå¦å‰‡é‹è²»ç‚º 100
        if (total >= 2500) {
            return 0;
        }
        return 100;
    }

    // ç¨ç«‹è™•ç†å‰©é¤˜é‡‘é¡çš„è¨ˆç®—
    function calculateRemainingForFreeShipping(total) {
        const freeShippingThreshold = 2500; // å…é‹è²»é–€æª»
        const messageElement = document.querySelector('.remaining-for-free-shipping');

        if (total >= freeShippingThreshold) {
            // å·²é”å…é‹æ¨™æº– â†’ è¨­å®šè—è‰²æ¨£å¼
            messageElement.innerText = 'å·²é”å…é‹é–€æª» ğŸ‰';
            messageElement.classList.remove('not-free');
            messageElement.classList.add('free');
        } else {
            // æœªé”å…é‹æ¨™æº– â†’ è¨­å®šç´…è‰²æ¨£å¼
            const remaining = freeShippingThreshold - total;
            messageElement.innerText = `é‚„å·® $${remaining} æ‰èƒ½å…é‹`;
            messageElement.classList.remove('free');
            messageElement.classList.add('not-free');
        }
    }

    function applyCoupon() {
        let couponCode = document.getElementById('coupon-code').value.trim();
    
        if (!couponCode) {
            showToast('è«‹è¼¸å…¥å„ªæƒ ç¢¼', false);
            return;
        }
    
        // æŒ‰ä¸‹æ™‚å…ˆé¡¯ç¤º loading
        const btn = document.querySelector('.coupon-btn');
        btn.innerHTML = `<span class="spinner-border spinner-border-sm text-success" role="status"></span>`;
        btn.setAttribute('disabled', 'disabled');
    
        $.ajax({
            url: '/apply_coupon/',
            type: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            data: {
                coupon_code: couponCode,
                'selected_keys': JSON.stringify(getSelectedKeys())
            },
            success: function(response) {
                if (response.success) {
                    updateCartSummary();
                    showToast(response.message, true);

                    setTimeout(() => {
                        switchToAppliedStyle(); // é 300ms å†æ›æ¨£å¼
                    }, 300);
                    //switchToAppliedStyle();
                } else {
                    showToast(response.message, false);
                    resetCouponButton();
                }
            },
            error: function() {
                showToast('å¥—ç”¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', false);
                resetCouponButton();
            }
        });
    }

    function cancelCoupon() {
        $.ajax({
            url: '/cancel_coupon/',
            type: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            success: function(response) {
                if (response.success) {
                    $('#coupon-code').val(''); // æ¸…ç©ºæ¬„ä½
                    updateCartSummary();
                    resetCouponButton();
                    showToast('å·²å–æ¶ˆå„ªæƒ ç¢¼', true);
                }
            },
            error: function() {
                showToast('å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', false);
            }
        });
    }

    function switchToAppliedStyle() {
        const btn = document.querySelector('.coupon-btn');

        // ç§»é™¤èˆŠçš„ tooltip å¯¦ä¾‹
        if (bootstrap.Tooltip.getInstance(btn)) {
            bootstrap.Tooltip.getInstance(btn).dispose();
        }

        btn.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i>`;
        btn.classList.add('bg-light');
        btn.setAttribute('data-bs-toggle', 'tooltip');
        btn.setAttribute('data-bs-placement', 'top');
        btn.setAttribute('data-bs-title', 'æŒ‰ä¸€ä¸‹å–æ¶ˆå¥—ç”¨');
        btn.onclick = cancelCoupon;
        btn.removeAttribute('disabled');

        // åˆå§‹åŒ– tooltip
        new bootstrap.Tooltip(btn);
    }
    
    function resetCouponButton() {
        const btn = document.querySelector('.coupon-btn');

        // ç§»é™¤èˆŠçš„ tooltip å¯¦ä¾‹
        if (bootstrap.Tooltip.getInstance(btn)) {
            bootstrap.Tooltip.getInstance(btn).dispose();
        }

        btn.innerHTML = `<i class="bi bi-check"></i>`;
        btn.classList.remove('bg-light');
        btn.setAttribute('data-bs-toggle', 'tooltip');
        btn.setAttribute('data-bs-placement', 'top');
        btn.setAttribute('data-bs-title', 'é»æ“Šå¥—ç”¨å„ªæƒ åˆ¸');
        btn.onclick = applyCoupon;
        btn.removeAttribute('disabled');

        // é‡æ–°å•Ÿç”¨ tooltip
        new bootstrap.Tooltip(btn);
    }
        

    // ç²å–é¸å–çš„å•†å“ key
    function getSelectedKeys() {
        let selectedKeys = [];
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            if (checkbox.checked) {
                selectedKeys.push(checkbox.closest('tr').getAttribute('data-key'));
            }
        });
        return selectedKeys;
    }

    // å‹¾é¸å•†å“æ™‚å³æ™‚æ›´æ–°è³¼ç‰©è»Šé‡‘é¡èˆ‡æŠ˜æ‰£
    function updateCartSummary() {
        let selectedKeys = getSelectedKeys();

        $.ajax({
            url: '/update_cart_summary/',
            type: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            data: {
                'selected_keys': JSON.stringify(selectedKeys)
            },
            success: function(response) {
                $('.total-amount').text(`$${response.total}`);
                $('.shipping-cost').text(`$${response.shipping_cost}`);
                $('#discount-amount').text(`$${response.discount}`);
                $('.final-amount').text(`$${response.final_total}`);

                // æ›´æ–°å„ªæƒ é …ç›®ï¼ˆå‹•æ…‹ç”Ÿæˆ ul æˆ– pï¼‰
                let promoContainer = $('#collapseDiscount .accordion-body');
                promoContainer.empty();  // å…ˆæ¸…ç©ºå…§å®¹

                if (response.active_promotions.length > 0) {
                    let promoList = $('<ul></ul>');
                    response.active_promotions.forEach(promo => {
                        promoList.append(`<li>${promo.promo_name} ${promo.conditions}- æŠ˜æ‰£ $${promo.discount}</li>`);
                    });
                    promoContainer.append(promoList);
                } else {
                    promoContainer.append('<p>å°šæœªå¥—ç”¨å„ªæƒ </p>');
                }

                // æ¸…é™¤èˆŠçš„è´ˆå“åˆ—è¡¨ï¼Œé¿å…é‡è¤‡é¡¯ç¤º
                $('#gift-list').empty();
                // æ›´æ–°è´ˆå“
                if (response.gifts.length > 0) {
                    
                    let giftList = response.gifts.map(gift =>
                        `<li class="mt-2">
                            ${gift.promo_name}
                            ${gift.conditions}
                            - è´ˆå“: 
                            ${gift.product_name}
                            ${gift.size ? `- ${gift.size}` : ''}
                            ${gift.package && gift.package !== 'å–®å…¥' ? `- ${gift.package}` : ''}
                            x ${gift.quantity}
                            ${gift.source === 'auto' ? '<span class="badge bg-success ms-2">æ´»å‹•</span>' : ''}
                            ${gift.source === 'coupon' ? '<span class="badge bg-primary ms-2">å„ªæƒ ç¢¼</span>' : ''}
                        </li>`
                    ).join('');
                    $('#gift-list').html(giftList);
                    $('#gift-row').removeClass('d-none').addClass('d-table-row');
                    
                } else {
                    $('#gift-row').addClass('d-none');
                }
            }
        });
    }

    // æ›´æ–°ç¸½é‡‘é¡
    function updateTotal() {
        let total = 0;
        let discount = parseFloat(document.querySelector('#discount-amount').innerText.replace('$', '').trim()) || 0; // ç²å–ç•¶å‰æŠ˜æ‰£

        // åªåŠ ç¸½é¸å–çš„å•†å“
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            if (checkbox.checked) {
                let row = checkbox.closest('tr');
                let value = row.querySelector('.subtotal').innerText.replace('$', '').trim();
                total += Number(value) || 0;
            }
        });

        let shipping = calculateShipping(total);

        let finalTotal = total + shipping - discount;

        // æ›´æ–°é¡¯ç¤º
        document.querySelector('.total-amount').innerText = `$${total}`;
        document.querySelector('.final-amount').innerText = `$${finalTotal}`;
        document.querySelector('.shipping-cost').innerText = `$${shipping}`;

        // æ›´æ–°å‰©é¤˜é‡‘é¡æç¤º
        calculateRemainingForFreeShipping(total);

    }


    function goToCheckOrder() {
        const selectedKeys = getSelectedKeys();  // å·²æœ‰çš„å‡½å¼
        $.ajax({
            url: '/save_selected_items/',
            type: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            data: {
                'selected_keys': JSON.stringify(selectedKeys)
            },
            success: function(response) {
                if (response.success) {
                    window.location.href = "/check_order/";
                }
            }
        });
    }  


</script>
{% endblock script %}
